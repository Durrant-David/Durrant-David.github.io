<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        var selectable = false;
        var players = 2;

        document.addEventListener("DOMContentLoaded", function() {
            loadFiles("https://salty-tundra-18278.herokuapp.com/cityCouncil/api.php", buildDeck);
        });

        function loadFiles(url, callback) {
            var xmlhttp = new XMLHttpRequest();

            xmlhttp.open("GET", url, true);
            xmlhttp.onload = function() {
                var data = this.responseText;
                callback(data);
            };
            xmlhttp.send();
        }

        function buildDeck(data) {
            var cards = JSON.parse(data);
            if (localStorage.getItem("cards") === null) {
                localStorage.setItem("cards", JSON.stringify(cards.cards));
                localStorage.setItem("turns", "0");
                startBoard();
            }
            getTurn();
        }

        function getTurn() {
            loadCards();
            var turns = Number(localStorage.turns);
            if (turns < (25 - players)) {
                localStorage.turns = ++turns;
                selectable = true;
            }
        }

        function drawCard(location, from) {
            var i = 0;
            while (i < 1) {
                num = Math.floor(Math.random() * 30);
                if (checkCardLocation(num, from) == true) {
                    setCard(num, location);
                    return (num);
                }
            }
        }

        function startBoard() {
            drawCard("draw0", "deck");
            drawCard("draw1", "deck");
            drawCard("draw2", "deck");
            drawCard("draw3", "deck");
            switch (players) {
                case 4:
                    cardId = drawCard("b32", "start");
                case 3:
                    cardId = drawCard("b12", "start");
                    rotateCard(cardId, 2);
                default:
                    cardId = drawCard("b23", "start");
                    rotateCard(cardId, 1);
                    cardId = drawCard("b21", "start");
                    rotateCard(cardId, 2);

            }
        }

        function setCard(id, location) {
            var cards = JSON.parse(localStorage.cards);
            cards[id].location = location;
            localStorage.setItem("cards", JSON.stringify(cards));
        }

        function rotateCard(id, top = null) {
            var cards = JSON.parse(localStorage.cards);
            cardTop = cards[id].top;
            if (top == null) {
                if (cardTop > 3) {
                    cards[id].top = "0";
                } else {
                    cardTop++;
                    cards[id].top = String(cardTop);
                }
            } else {
                cards[id].top = String(top);
            }
            localStorage.setItem("cards", JSON.stringify(cards));
        }

        function checkCardLocation(id, from) {
            var cards = JSON.parse(localStorage.cards);
            if (cards[id].location == from) {
                return true;
            } else {
                return false;
            }
        }

        function getCardInLocation(from) {
            var cards = JSON.parse(localStorage.cards);
            for (var i = 0; i < cards.length; i++) {
                if (cards[i].location == from) {
                    return cards[i].id;
                } else {
                    return 0;
                }
            }
        }

        function loadCards() {
            var cards = JSON.parse(localStorage.cards);
            for (var i = 0; i < cards.length; i++) {
                if (cards[i].location != "deck" && cards[i].location != "start") {
                    makeCard(i);
                }
            }
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("id", ev.target.id);
        }

        function drop(ev) {
            ev.preventDefault();
            var data = ev.dataTransfer.getData("id");
            ev.target.appendChild(document.getElementById(data));
            ev.target.classList.remove("empty");
            data.classList.add("empty");
            
        }

        function dropCard(element) {
            var card = localStorage.selected;
            console.log(card);
            element.appendChild(document.getElementById(card));
            element.classList.remove("empty");
            selected(document.getElementById(card));
            
            var btnContainer = document.createElement("DIV");
            var confirm = document.createElement("BUTTON");
            var rotate = document.createElement("BUTTON");
            var cancel = document.createElement("BUTTON");
            btnContainer.append(confirm);
            btnContainer.append(rotate);
            btnContainer.append(cancel);
            element.appendChild(btnContainer);
        }

        function selected(element) {
            if (selectable) {
                var turn = Number(localStorage.turns);
                var color;
                switch (turn % players) {
                    case 1:
                        color = "red";
                        break;
                    case 2:
                        color = "green";
                        break;
                    case 3:
                        color = "blue";
                        break;
                    case 4:
                        color = "yellow";
                        break;
                } 
                
                if (element.classList.contains("selected")) {
                    element.classList.remove("selected");
                } else {
                    element.classList.add("selected");
                    element.style["boxShadow"] = "0px 0px 20px red";
                    localStorage.setItem("selected", element.getAttribute("id"));
                }
            }
        }

        function makeCard(id) {
            var cards = JSON.parse(localStorage.cards);
            var element = document.getElementById(cards[id].location);
            var container = document.createElement("DIV");
            container.setAttribute("id", id);
            container.setAttribute("class", "grid-card");
            container.setAttribute("onclick", "selected(this)");
            var corner = document.createElement("DIV");
            corner.setAttribute("class", "card-corner");

            var bottom = document.createElement("DIV");
            var left = document.createElement("DIV");
            var right = document.createElement("DIV");
            var bonus = parseInt(cards[id].top);
            var sides = [];
            for (var i = 0; i < 4; i++) {
                sides[i] = cards[id].bonus[bonus]

                if (bonus == 3) {
                    bonus = 0;
                } else {
                    bonus++;
                }
            }

            var top = document.createElement("DIV");
            top.setAttribute("class", "card-vertical");
            if (sides[0] == "+" || sides[0] == "-") {
                top.innerHTML = sides[0];
            } else {
                top.style.backgroundColor = sides[0];
            }

            var bottom = document.createElement("DIV");
            bottom.setAttribute("class", "card-vertical");
            if (sides[1] == "+" || sides[1] == "-") {
                bottom.innerHTML = sides[1];
            } else {
                bottom.style.backgroundColor = sides[1];
            }

            var left = document.createElement("DIV");
            left.setAttribute("class", "card-horizontal");
            if (sides[2] == "+" || sides[2] == "-") {
                left.innerHTML = sides[2];
            } else {
                left.style.backgroundColor = sides[2];
            }

            var right = document.createElement("DIV");
            right.setAttribute("class", "card-horizontal");
            if (sides[3] == "+" || sides[3] == "-") {
                right.innerHTML = sides[3];
            } else {
                right.style.backgroundColor = sides[3];
            }

            var center = document.createElement("DIV");
            center.setAttribute("class", "card-center");
            center.style.backgroundColor = cards[id].basecolor;
            center.innerHTML = cards[id].name + "<br>" + cards[id].basenum;

            container.appendChild(corner);
            container.appendChild(top);
            container.appendChild(corner.cloneNode(true));
            container.appendChild(left);
            container.appendChild(center);
            container.appendChild(right);
            container.appendChild(corner.cloneNode(true));
            container.appendChild(bottom);
            container.appendChild(corner.cloneNode(true));

            element.appendChild(container);
            element.classList.remove("empty");
        }
    </script>
</head>

<body>
    <p id="demo"></p>
    <div id="drawPile">
        <div class="grid-container">
            <div id="draw-pile" class="draw-pile">Draw<br>Pile</div>
            <div id="draw0" class="empty"></div>
            <div id="draw1" class="empty"></div>
            <div id="draw2" class="empty"></div>
            <div id="draw3" class="empty"></div>

            <div class="blank"></div>
            <div class="blank">6</div>
            <div class="blank">4</div>
            <div class="blank">2</div>
            <div class="blank">1</div>
        </div>
    </div>
    <div id="board">
        <div class="grid-container">
            <div id="b00" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b01" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b02" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b03" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b04" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b10" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b11" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b12" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b13" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b14" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b20" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b21" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b22" class="center">City Square<br>
                <font size="10">1</font>
            </div>
            <div id="b23" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b24" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b30" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b31" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b32" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b33" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b34" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b40" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b41" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b42" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b43" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
            <div id="b44" class="empty" onclick="dropCard(this)" ondragover="allowDrop(event)"></div>
        </div>
    </div>

</body></html>
